name: Prerelease
on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'     
        required: true
        default: 'warning'

jobs:

  build:
   name: build
   runs-on: ubuntu-latest
   steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16

    - name: Install Modules
      run: go mod tidy
      
    - name: Build
      run: go build -v ./...

    - name: Archive production artifacts
      uses: actions/upload-artifact@v2
      with:
          name: start_build
          
releases-matrix: 
      name: release 
      runs-on: ubuntu-latest
      strategy:
       matrix:
        # build and publish in parallel: linux/386, linux/amd64, windows/386, windows/amd64, darwin/amd64 
        goos: [linux, windows, darwin]
        goarch: ["386", amd64]
        exclude:  
          - goarch: "386"
            goos: darwin 
            
      steps:
      - uses: actions/checkout@v2
      - uses: evantorrie/mott-the-tidier@v1-beta
        with:
         gomods: |
           **/go.mod
           -tools/go.mod
      - uses: wangyoucao577/go-release-action@v1.20
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          release_tag: v1.0
          overwrite: TRUE        
